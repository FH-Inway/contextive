name: Contextive
on:
  push:
    paths:
      - 'src/**'
      - '.github/workflows/contextive.yml'
      - '.github/workflows/contextive-runtime-build.yml'
      - '.github/workflows/get-matrix.yml'
      - '.github/build-matrix.yml'
      - '.github/actions/**'
env:
  DOTNET_VERSION: '7.0.x'

jobs:
  get-matrix:
    uses: ./.github/workflows/get-matrix.yml
    with:
      matrix-path: .github/build-matrix.yml

  build-test-per-runtime:
    needs: get-matrix
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.get-matrix.outputs.matrix) }}
    uses: ./.github/workflows/contextive-runtime-build.yml
    with:
      dotnet_runtime: ${{ matrix.dotnet_runtime }}
      os: ${{ matrix.os }}

  build-test-intellij:
    name: IntelliJ Plugin
    runs-on: 'ubuntu-latest'
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false
      - uses: actions/setup-java@v4
        with:
          distribution: 'corretto'
          java-version: '21'

      # - name: Language Server Artifact
      #   uses: actions/download-artifact@v3
      #   with:
      #     name: Contextive.LanguageServer-${{ inputs.dotnet_runtime }}
      #     path: src/

      - name: Build
        run: ./gradlew build
        working-directory: src/intellij/contextive

      # - uses: ./.github/actions/upload-reports
      #   if: always()
      #   with:
      #     name: 'Contextive VsCode Extension'
      #     reporter: java-junit